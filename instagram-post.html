authorId<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="instagram-post">
  <template>
    <style>
      :host {
        display: block;
        --playbutton-opacity: 0;
      }
      :host([hidden]) {
        display: none;
      }
      .bolded {
        font-weight: 600;
      }
      .gray {
        color: #999;
      }
      .instagram-avatar img{
        border-radius: 50%;
        height: 30px;
      }
      .instagram-author {
        color:#262626;
        font-family:Arial,sans-serif;
        font-size:14px;
        font-weight: 600;
        font-style:normal;
        line-height:17px;
      }
      .instagram-footer {
        vertical-align: middle;
        -webkit-box-align:center;
        -webkit-align-items:center;
        -ms-flex-align:center;
        align-items:center;
        border-top:1px solid #eee;
        -webkit-box-orient:horizontal;
        -webkit-box-direction:normal;
        -webkit-flex-direction:row;
        -ms-flex-direction:row;
        flex-direction:row;
        height:24px;
        padding:10px
      }
      .instagram-glyph {
        display: inline-block;
        float: right;
        -webkit-box-align:center;
        -webkit-align-items:center;
        -ms-flex-align:center;
        align-items:center;
        vertical-align: middle;
        height: 24px;
        width: 26px;
        overflow: hidden;
        background-position: -24px 0px;
        background-image: url(f8cfa266e12d.png);
        background-size: 74px 49px;
      }
      .instagram-header {
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
        display: -webkit-box;
        display: -webkit-flex;
        display: ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -webkit-flex-direction: row;
        -ms-flex-direction: row;
        flex-direction: row;
        height: 34px;
        padding: 10px;
      }
      .instagram-image {
        width:100%;
      }
      .instagram-logo {
        background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC);
        display:block;
        height:44px;
        margin:0 auto -44px;
        position:relative;
        top:-22px;
        width:44px;
      }
      .instagram-playbutton {
        display: block;
        height: 135px;
        left: 50%;
        margin-left: -67px;
        margin-top: -67px;
        top: 50%;
        width: 135px;
        position: absolute;
        background-image: url(06390c4e5e96.png);
        background-size: 152px 135px;
        background-position: 0 0;
        transition-property: opacity;
        transition-duration: 0.2s;
        transition-timing-function: ease-out;
        transition-delay: .1s;
        opacity: var(--playbutton-opacity);
      }
      .instagram-post {
        background:#FFF;
        border:0;
        border-radius:3px;
        box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15);
        margin: 1px;
        max-width:658px;
        padding:0;
        width:99.375%;
        width:-webkit-calc(100% - 2px);
        width:calc(100% - 2px);
      }
      .instagram-temp {
        background:#F8F8F8;
        line-height:0;
        padding:62.5% 0;
        text-align:center;
        width:100%;
      }
      .instagram-text {
        color:#000;
        font-size:14px;
        font-style:normal;
        font-weight:normal;
        line-height:17px;
        text-decoration:none;
        word-wrap:break-word;
      }
      .instagram-textbox {
        margin:8px 0 0 0;
        padding:0 10px;
      }
      .instagram-textcontent {
        padding-bottom: 10px;
      }
      .instagram-time {
        display: inline-block;
        font-size:12px;
        text-decoration: none;
        line-height:17px;
      }
      .instagram-username {
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
        display: -webkit-box;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -webkit-flex-direction: row;
        -ms-flex-direction: row;
        flex-direction: row;
        font-weight: 600;
        color: #262626;
        text-decoration: none;
        padding: 0 10px;
      }
      .instagram-verified {
        height: 12px;
        width: 12px;
        overflow: hidden;
        background-position: -50px -25px;
        background-image: url(f8cfa266e12d.png);
        background-size: 74px 49px;
      }
      .instagram-video {
        width: 100%;
        height: 100%;
        position: relative;
      }
    </style>

    <blockquote class="instagram-post">
      <div class="instagram-header">
        <a class="instagram-avatar" href$=[[_authorUrl]] target="_blank">
          <img id="instagramAvatar" alt$=[[authorId]]>
        </a>
        <a class="instagram-username" href$=[[_authorUrl]] target="_blank">
          [[authorId]]
        </a>
        <span class="instagram-verified" hidden$=[[!verified]]>
        </span>
      </div>
      <div class="instagram-textcontent">
        <div hidden$=[[!loaded]]>
          <a href$=[[_instagramUrl]] hidden$=[[_isvideo]]>
            <img id="instagramImage" class="instagram-image">
          </a>
          <div class="instagram-video" hidden$=[[!_isvideo]]>
            <video id="instagramVideo" on-click="_clickVideo" on-mouseover="_videoHover" on-mouseout="_videoUnhover" width="100%" loop preload="none" type="video/mp4" ></video>
            <div id="instagramPlaybutton" class="instagram-playbutton" on-click="_clickVideo" on-mouseover="_videoHover" on-mouseout="_videoUnhover"></div>
          </div>
        </div>
        <div class="instagram-temp" hidden$=[[loaded]]>
          <div class="instagram-logo"></div>
        </div>
        <p class="instagram-textbox" hidden$=[[!loaded]]>
          <a class="instagram-text bolded" href$=[[_instagramUrl]] target="_blank">[[_instaObject.likes]] likes</a>
        </p>
        <p class="instagram-textbox" hidden$=[[!loaded]]>
          <a href$=[[_authorUrl]] class="instagram-author" target="_blank">[[authorId]]</a> <a class="instagram-text" href$=[[_instagramUrl]] target="_blank">[[_instaObject.instagramText]]</a>
        </p>
        <p class="instagram-textbox" hidden$=[[!loaded]]>
          <a class="instagram-text gray" href$=[[_instagramUrl]] target="_blank">view all [[_instaObject.comments]] comments</a>
        </p>
      </div>
      <div class="instagram-footer">
        <a class="instagram-time gray" href="#">[[_humanDate]]</a>
        <span class="instagram-glyph"></span>
      </div>
      </blockquote>
  </template>

  <script>
    /**
     * `instagram-post`
     * Display an Instagram post in your Polymer website
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class InstagramPost extends Polymer.Element {
      static get is() { return 'instagram-post'; }
      static get properties() {
        return {
          /**
          * postid: ID of Instagram post
          * @type {String}
          */
          postid: {
            type: String
          },
          /**
          * _authorId: Author ID of the Instagram post
          * @type {String}
          */
          /**
          * _authorUrl: Computed URL leading to author's Instagram page
          * @type {String}
          */
          _authorUrl: {
            type: String,
            computed: '_computeAuthorUrl(authorId)'
          },
          /**
          * _graphType: Either GraphImage or GraphVideo from Instragram's POST data
          * @type {String}
          */
          _graphType: {
            type: String
          },
          /**
          * _humanDate: Computed Human readable date
          * @type {String}
          */
          _humanDate: {
            type: String,
            computed: '_computeHumanDate(_instaObject.timestamp)'
          },
          /**
          * _instaObject: Container for post details
          * @type {Object}
          */
          _instaObject: {
            type: Object,
            value: {}
          },
          /**
          * _instagramUrl: Computed URL of instagram post
          * @type {String}
          */
          _instagramUrl: {
            type: String,
            computed: '_buildUrl(postid)',
            observer: '_getInstagramAPI'
          },
          /**
          * _isvideo: Enabled video container
          * @type {Boolean}
          */
          _isvideo: {
            type: Boolean,
            value: false,
            computed: '_computeIsVideo(graphType)'
          },
          /**
          * _loaded: Flag for when data has been loaded from Instagram
          * @type {Boolean}
          */
          _loaded: {
            type: Boolean,
            value: false
          },
          /**
          * _playing: Flag for wether video is playing
          * @type {Boolean}
          */
          _playing: {
            type: Boolean,
            value: false
          }
        };
      }

      _buildUrl(postid) {
        if (!postid)
          return;
        return 'https://www.instagram.com/p/' + postid;
      }

      _clickVideo(e) {
        if (!this._playing) {
          this.$.instagramVideo.play();
          this.updateStyles({'--playbutton-opacity': 0});
          this.set('_playing', true);
        }
        else {
          this.$.instagramVideo.pause();
          this.updateStyles({'--playbutton-opacity': 1});
          this.set('_playing', false);
        }
      }

      _computeAuthorUrl(authorId) {
        if (!authorId)
          return;
        return 'https://www.instagram.com/' + authorId;
      }

      _computeHumanDate(timestamp) {
        if (!timestamp)
          return;
        let postDate = new Date(timestamp*1000);
        let elapsedTime = new Date() - postDate
        if ( elapsedTime < 84400000*7) {
          return Math.round(elapsedTime/84400000) + " days ago"
        } else {
          var options = { year: 'numeric', month: 'long', day: 'numeric' };
          return postDate.toLocaleDateString("en-US",options)
        }
      }
      _computeIsVideo(graphType) {
        if (!graphType)
          return;
        if (graphType == 'GraphVideo') {
          this.$.instagramVideo.poster = this._instaObject.imgSrc;
          this.$.instagramVideo.src = this._instaObject.videosrc;
          return true;
        }
        else {
          this.$.instagramImage.src = this._instaObject.imgSrc;
          return false;
        }
      }

      _getInstagramAPI(instagramUrl) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("load", (e) => {
          if (e.target.status == 200) {
            let responseObj = JSON.parse(e.target.response);
            let graphql = responseObj.graphql.shortcode_media;
            this.set('_instaObject.imgSrc', graphql.display_url);
            this.set('_instaObject.videosrc', graphql.video_url);
            this.set('_instaObject.instagramText', graphql.edge_media_to_caption.edges[0].node.text);
            this.set('graphType', graphql.__typename);
            this.set('authorId', graphql.owner.username);
            this.set('_instaObject.timestamp', graphql.taken_at_timestamp);
            this.set('_instaObject.authorAvatar', graphql.owner.profile_pic_url);
            this.$.instagramAvatar.src = this._instaObject.authorAvatar;
            this.set('_instaObject.likes', graphql.edge_media_preview_like.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
            this.set('_instaObject.comments', graphql.edge_media_to_comment.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
            this.set('_instaObject.verified', graphql.owner.is_verified);
            this.set('loaded', true);
          }
        });
        xhr.open("GET", this._instagramUrl + "/?__a=1");
        xhr.send();
      }

      _videoHover(){
        if (!this._playing)
          this.updateStyles({'--playbutton-opacity': 1});
      }

      _videoUnhover(){
        this.updateStyles({'--playbutton-opacity': 0});
      }

      connectedCallback() {
        super.connectedCallback();
      }
    }

    window.customElements.define(InstagramPost.is, InstagramPost);
  </script>
</dom-module>
