<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="./instagram-post-image.html">
<link rel="import" href="./instagram-post-video.html">

<dom-module id="instagram-post">
  <template>
    <style>
    :host {
      display: block;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }
    :host([hidden]) {
      display: none;
    }
    blockquote {
      background:#FFF;
      border:0;
      border-radius:3px;
      box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15);
      margin: 1px;
      max-width:658px;
      padding:0;
      width:99.375%;
      width:-webkit-calc(100% - 2px);
      width:calc(100% - 2px);
    }
    .bolded {
      font-weight: 600;
    }
    .black {
      color: #000;
    }
    .gray {
      color: #999;
    }
    .instagram-author {
      color:#262626;
      font-family:Arial,sans-serif;
      font-size:14px;
      font-weight: 600;
      font-style:normal;
      line-height:17px;
    }
    .instagram-avatar{
      height: 30px;
      width: 30px;
    }
    .instagram-avatar img{
      border-radius: 50%;
      height: 30px;
      width: 30px;
    }
    .instagram-footer {
      vertical-align: middle;
      -webkit-box-align:center;
      -webkit-align-items:center;
      -ms-flex-align:center;
      align-items:center;
      border-top:1px solid #eee;
      -webkit-box-orient:horizontal;
      -webkit-box-direction:normal;
      -webkit-flex-direction:row;
      -ms-flex-direction:row;
      flex-direction:row;
      height:24px;
      padding:10px
    }
    .instagram-glyph {
      display: inline-block;
      float: right;
      -webkit-box-align:center;
      -webkit-align-items:center;
      -ms-flex-align:center;
      align-items:center;
      vertical-align: middle;
      height: 24px;
      width: 26px;
      overflow: hidden;
      background-position: -24px 0px;
      background-image: url(f8cfa266e12d.png);
      background-size: 74px 49px;
    }
    .instagram-header {
      -webkit-box-align: center;
      -webkit-align-items: center;
      -ms-flex-align: center;
      align-items: center;
      display: -webkit-box;
      display: -webkit-flex;
      display: ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -webkit-flex-direction: row;
      -ms-flex-direction: row;
      flex-direction: row;
      height: 34px;
      padding: 10px;
    }
    .instagram-logo {
      background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC);
      display:block;
      height:44px;
      margin:0 auto -44px;
      position:relative;
      top:-22px;
      width:44px;
    }
    .instagram-playbutton {
      display: block;
      height: 135px;
      left: 50%;
      margin-left: -67px;
      margin-top: -67px;
      top: 50%;
      width: 135px;
      position: absolute;
      background-image: url(06390c4e5e96.png);
      background-size: 152px 135px;
      background-position: 0 0;
      transition-property: opacity;
      transition-duration: 0.3s;
      transition-timing-function: ease-out;
      transition-delay: .1s;
      opacity: var(--playbutton-opacity);
    }
    .instagram-temp {
      background:#F8F8F8;
      line-height:0;
      padding:62.5% 0;
      text-align:center;
      width:100%;
    }
    .instagram-text {
      font-size:14px;
      font-style:normal;
      font-weight:normal;
      line-height:17px;
      text-decoration:none;
      word-wrap:break-word;
    }
    .instagram-textbox {
      margin:8px 0 0 0;
      padding:0 10px;
    }
    .instagram-textcontent {
      padding-bottom: 10px;
    }
    .instagram-time {
      display: inline-block;
      font-size:12px;
      text-decoration: none;
      line-height:17px;
      color: #999;
    }
    .instagram-username {
      -webkit-box-align: center;
      -webkit-align-items: center;
      -ms-flex-align: center;
      align-items: center;
      display: -webkit-box;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -webkit-flex-direction: row;
      -ms-flex-direction: row;
      flex-direction: row;
      font-weight: 600;
      color: #262626;
      text-decoration: none;
      padding: 0 10px;
    }
    .instagram-verified {
      height: 12px;
      width: 12px;
      overflow: hidden;
      background-position: -50px -25px;
      background-image: url(f8cfa266e12d.png);
      background-size: 74px 49px;
    }
    </style>
    <iron-ajax
      auto
      url="[[_instagramUrl]]"
      params='{"__a":"1"}'
      handle-as="json"
      last-response="{{_instaRes}}"
      debounce-duration="300">
    </iron-ajax>

    <blockquote class="instagram-container">
      <div class="instagram-header">
        <a class="instagram-avatar" href$=[[_authorUrl]] target="_blank">
          <img id="instagramAvatar" alt$=[[_authorId]]>
        </a>
        <a class="instagram-username" href$=[[_authorUrl]] target="_blank">
          <span>[[_authorId]]</span>
        </a>
        <template is="dom-if" if="[[_verified]]">
          <span class="instagram-verified">
        </template>
        </span>
      </div>
      <template id="templateImage" is="dom-if" if="{{!_isVideo(_instaObject.graphType)}}">
        <instagram-post-image id="elementImage" image="[[_instaObject.imgSrc]]">
        </instagram-post-image>
      </template>
      <template id="templateVideo" is="dom-if" if="{{_isVideo(_instaObject.graphType)}}">
        <instagram-post-video poster=[[_instaObject.imgSrc]] video=[[_instaObject.videoSrc]]>
        </instagram-video>
      </template>
      <div class="instagram-temp" hidden$=[[_loaded]]>
        <div class="instagram-logo"></div>
      </div>
      <div hidden$="[[!_loaded]]">
        <p class="instagram-textbox">
          <a class="instagram-text bolded black" href$=[[_instagramUrl]] target="_blank">[[_instaObject.likes]] likes</a>
        </p>
        <p class="instagram-textbox">
          <a href$=[[_authorUrl]] class="instagram-author" target="_blank">[[_authorId]]</a> <a class="instagram-text black" href$=[[_instagramUrl]] target="_blank">[[_instaObject.instagramText]]</a>
        </p>
        <p class="instagram-textbox">
          <a class="instagram-text gray" href$=[[_instagramUrl]] target="_blank">view all [[_instaObject.comments]] comments</a>
        </p>
      </div>
      <div class="instagram-footer">
        <a class="instagram-time gray" href="#">[[_humanDate]]</a>
        <span class="instagram-glyph"></span>
      </div>
    </blockquote>
  </template>

  <script>
  /**
  * `instagram-post`
  * Display an Instagram post in your Polymer website
  *
  * @customElement
  * @polymer
  * @demo demo/index.html
  */
  class InstagramPost extends Polymer.Element {
    static get is() { return 'instagram-post'; }
    static get properties() {
      return {
        /**
        * postid: ID of Instagram post
        */
        postid: {
          type: String
        },
        /**
        * _authorId: Author ID of the Instagram post
        */
        _authorId: {
          type: String
        },
        /**
        * _authorUrl: Computed URL leading to author's Instagram page
        */
        _authorUrl: {
          type: String,
          computed: '_computeAuthorUrl(_authorId)'
        },
        /**
        * _humanDate: Computed Human readable date
        */
        _humanDate: {
          type: String,
          computed: '_computeHumanDate(_instaObject.timestamp)'
        },
        /**
        * _loaded: Set true when received POST data from Instagram
        */
        _loaded: {
          type: Boolean,
          value: false
        },
        /**
        * _instaObject: Container for post details
        */
        _instaObject: {
          type: Object,
          value: {}
        },
        _instaRes: {
          type: Object,
          observer: '_observerInstagramAjax'
        },
        /**
        * _instagramUrl: Computed URL of instagram post
        */
        _instagramUrl: {
          type: String,
          computed: '_computeUrl(postid)'
        },
        /**
        * _playing: Flag for wether video is playing
        */
        _playing: {
          type: Boolean,
          value: false
        },
        _verified: {
          type: Boolean,
          value: false
        }
      };
    }

    _observerInstagramAjax(res) {
      if (!res) return;
      let graphql = res.graphql.shortcode_media;
      this.$.instagramAvatar.src = graphql.owner.profile_pic_url;
      this.set('_authorId', graphql.owner.username);
      this.set('_instaObject.imgSrc', graphql.display_url);
      this.set('_instaObject.videoSrc', graphql.video_url);
      this.set('_instaObject.instagramText', graphql.edge_media_to_caption.edges[0].node.text);
      this.set('_instaObject.graphType', graphql.__typename);
      this.set('_instaObject.timestamp', graphql.taken_at_timestamp);
      this.set('_instaObject.likes', graphql.edge_media_preview_like.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
      this.set('_instaObject.comments', graphql.edge_media_to_comment.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
      this.set('_verified', graphql.owner.is_verified);
      this.set('_loaded', true);
      this.dispatchEvent(new CustomEvent('test-event', {detail: "ready"}));
    }
    /**
     * Builds a URL for links to post author's Instagram page
     *
     * @param {String} authorId of the post
     * @return {String} URL of post author's page
     */
    _computeAuthorUrl(authorId) {
      if (!authorId) return;
      return 'https://www.instagram.com/' + authorId;
    }
    /**
     * For time elapsed of less than 10 days, returns a "X days ago" String
     * Else, returns the date in the format "Month DD, YYYY"
     *
     * @param {number} timestamp of the post
     * @return {String} Human readable date
     */
    _computeHumanDate(timestamp) {
      if (!timestamp) return;
      let postDate = new Date(timestamp*1000);
      let elapsedTime = new Date() - postDate
      if ( elapsedTime < 84400000*7) {
        return Math.round(elapsedTime/84400000) + " days ago"
      } else {
        var options = { year: 'numeric', month: 'long', day: 'numeric' };
        return postDate.toLocaleDateString("en-US",options)
      }
    }
    /**
     * Computes a URL required for the REST call to Instagram
     *
     * @param {String} postid of the
     * @return {String} URL of the post
     */
    _computeUrl(postid) {
      if (!postid) return;
      return 'https://www.instagram.com/p/' + postid;
    }
    /**
     * Instagram provides either "GraphVideo" or "GraphImage"
     * This will convert to boolean, required by dom-if's on the page
     *
     * @param {String} graphType of the post
     * @return {Boolean} True if Video, False if Image
     */
    _isVideo(graphType) {
      if (!graphType) return;
      if (graphType == 'GraphVideo')
        return true;
      else
        return false;
    }

    connectedCallback() {
      super.connectedCallback();
    }
  }

  window.customElements.define(InstagramPost.is, InstagramPost);
</script>
</dom-module>
