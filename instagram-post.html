<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="instagram-post">
  <template>
    <style>
      :host {
        display: block;
      }
      :host([hidden]) {
        display: none;
      }
      .instagram-post {
        background:#FFF;
        border:0;
        border-radius:3px;
        box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15);
        margin: 1px;
        max-width:658px;
        padding:0;
        width:99.375%;
        width:-webkit-calc(100% - 2px);
        width:calc(100% - 2px);
      }
      .instagram-header {
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
        display: -webkit-box;
        display: -webkit-flex;
        display: ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -webkit-flex-direction: row;
        -ms-flex-direction: row;
        flex-direction: row;
        height: 34px;
        padding: 10px;
      }
      .instagram-avatar img{
        border-radius: 50%;
        height: 30px;
      }
      .instagram-username {
        -webkit-box-align: center;
        -webkit-align-items: center;
        -ms-flex-align: center;
        align-items: center;
        display: -webkit-box;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -webkit-flex-direction: row;
        -ms-flex-direction: row;
        flex-direction: row;
        font-weight: 600;
        color: #262626;
        text-decoration: none;
        padding: 0 10px;
      }
      .instagram-verified {
        height: 12px;
        width: 12px;
        overflow: hidden;
        background-position: -50px -25px;
        background-image: url(https://www.instagram.com/static/bundles/sprite_embednew_2x.png/f8cfa266e12d.png);
        background-size: 74px 49px;
      }
      .instagram-image {
        width:100%;
      }
      .instagram-temp {
        background:#F8F8F8;
        line-height:0;
        padding:62.5% 0;
        text-align:center;
        width:100%;
      }
      .instagram-logo {
        background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC);
        display:block;
        height:44px;
        margin:0 auto -44px;
        position:relative;
        top:-22px;
        width:44px;
      }
      .instagram-textbox {
        margin:8px 0 0 0;
        padding:0 10px;
      }
      .instagram-text {
        color:#000;
        font-size:14px;
        font-style:normal;
        font-weight:normal;
        line-height:17px;
        text-decoration:none;
        word-wrap:break-word;
      }
      .instagram-author {
        color:#262626;
        font-family:Arial,sans-serif;
        font-size:14px;
        font-weight: 600;
        font-style:normal;
        line-height:17px;
      }
      .instagram-time {
        display: inline-block;
        font-size:12px;
        text-decoration: none;
        line-height:17px;
      }
      .instagram-glyph {
        display: inline-block;
        float: right;
        -webkit-box-align:center;
        -webkit-align-items:center;
        -ms-flex-align:center;
        align-items:center;
        vertical-align: middle;
        height: 24px;
        width: 26px;
        overflow: hidden;
        background-position: -24px 0px;
        background-image: url(https://www.instagram.com/static/bundles/sprite_embednew_2x.png/f8cfa266e12d.png);
        background-size: 74px 49px;
      }
      .bolded {
        font-weight: 600;
      }
      .gray {
        color: #999;
      }
      .instagram-textcontent {
        padding-bottom: 10px;
      }
      .instagram-footer {
        vertical-align: middle;
        -webkit-box-align:center;
        -webkit-align-items:center;
        -ms-flex-align:center;
        align-items:center;
        border-top:1px solid #eee;
        -webkit-box-orient:horizontal;
        -webkit-box-direction:normal;
        -webkit-flex-direction:row;
        -ms-flex-direction:row;
        flex-direction:row;
        height:24px;
        padding:10px
      }
    </style>

    <blockquote class="instagram-post">
      <div class="instagram-header">
        <a class="instagram-avatar" href$=[[authorUrl]] target="_blank">
          <img src$=[[authorAvatar]] alt$=[[authorId]]>
        </a>
        <a class="instagram-username" href$=[[authorUrl]] target="_blank">
          [[authorId]]
        </a>
        <span class="instagram-verified" hidden$=[[!verified]]>
        </span>
      </div>
      <div class="instagram-textcontent">
        <div hidden$=[[!loaded]]>
          <a href$=[[instagramUrl]] hidden$=[[isvideo]] >
            <img class="instagram-image" src$=[[imgSrc]]>
          </a>
          <video hidden$=[[!isvideo]] width="100%" autoplay poster="[[imgSrc]]" preload="none" src="[[videosrc]]" type="video/mp4"></video>
        </div>
        <div class="instagram-temp" hidden$=[[loaded]]>
          <div class="instagram-logo"></div>
        </div>
        <p class="instagram-textbox" hidden$=[[!loaded]]>
          <a class="instagram-text bolded" href$=[[instagramUrl]] target="_blank">[[likes]] likes</a>
        </p>
        <p class="instagram-textbox" hidden$=[[!loaded]]>
          <a href$=[[authorUrl]] class="instagram-author" target="_blank">[[authorId]]</a> <a class="instagram-text" href$=[[instagramUrl]] target="_blank">[[instagramText]]</a>
        </p>
        <p class="instagram-textbox" hidden$=[[!loaded]]>
          <a class="instagram-text gray" href$=[[instagramUrl]] target="_blank">view all [[comments]] comments</a>
        </p>
      </div>
      <div class="instagram-footer">
        <a class="instagram-time gray" href="#">[[humanDate]]</a>
        <span class="instagram-glyph"></span>
      </div>
      </blockquote>
  </template>

  <script>
    /**
     * `instagram-post`
     * Display an Instagram post in your Polymer website
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class InstagramPost extends Polymer.Element {
      static get is() { return 'instagram-post'; }
      static get properties() {
        return {
          authorAvatar: {
            type: String
          },
          authorId: {
            type: String
          },
          authorName: {
            type: String
          },
          authorUrl: {
            type: String,
            computed: '_computeAuthorUrl(authorId)'
          },
          comments: {
            type: String
          },
          postid: {
            type: String
          },
          humanDate: {
            type: String,
            computed: '_computeHumanDate(timestamp)'
          },
          imgSrc: {
            type: String
          },
          instagramText: {
            type: String
          },
          instagramUrl: {
            type: String,
            computed: '_buildUrl(postid)',
            observer: '_getInstagramAPI'
          },
          isvideo: {
            type: Boolean,
            value: false,
            computed: '_computeIsVideo(graphtype)'
          },
          likes: {
            type: String
          },
          loaded: {
            type: Boolean,
            value: false
          },
          timestamp: {
            type: Number
          },
          graphtype: {
            type: String
          },
          verified: {
            type: Boolean,
            value: false
          },
          videosrc: {
            type: String
          }

        };
      }
      _buildUrl(postid) {
        if (!postid)
          return;
        return 'https://www.instagram.com/p/' + postid;
      }

      _computeAuthorUrl(authorId) {
        if (!authorId)
          return;
        return 'https://www.instagram.com/' + authorId;
      }

      _computeHumanDate(timestamp) {
        if (!timestamp)
          return;
        let postDate = new Date(timestamp*1000);
        let elapsedTime = new Date() - postDate
        if ( elapsedTime < 84400000*7) {
          return Math.round(elapsedTime/84400000) + " days ago"
        } else {
          var options = { year: 'numeric', month: 'long', day: 'numeric' };
          return postDate.toLocaleDateString("en-US",options)
        }
      }
      _computeIsVideo(graphtype) {
        if (!typename)
          return;
        if (graphtype == 'GraphVideo') return true
        else return false
      }

      _getInstagramAPI(instagramUrl) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("load", (e) => {
          if (e.target.status == 200) {
            let responseObj = JSON.parse(e.target.response);
            let graphql = responseObj.graphql.shortcode_media;
            this.set('imgSrc', graphql.display_url);
            this.set('videosrc', graphql.video_url);
            this.set('graphtype', graphql.__typename);
            this.set('instagramText', graphql.edge_media_to_caption.edges[0].node.text);
            this.set('authorId', graphql.owner.username);
            this.set('authorName', graphql.owner.full_name);
            this.set('timestamp', graphql.taken_at_timestamp);
            this.set('authorAvatar', graphql.owner.profile_pic_url);
            this.set('likes', graphql.edge_media_preview_like.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
            this.set('comments', graphql.edge_media_to_comment.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
            this.set('verified', graphql.owner.is_verified);
            this.set('loaded', true);
          }
        });
        xhr.open("GET", this.instagramUrl + "/?__a=1");
        xhr.send();
      }

      connectedCallback() {
        super.connectedCallback();
      }
    }

    window.customElements.define(InstagramPost.is, InstagramPost);
  </script>
</dom-module>
