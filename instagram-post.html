<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="./instagram-post-header.html">
<link rel="import" href="./instagram-post-image.html">
<link rel="import" href="./instagram-post-video.html">
<link rel="import" href="./instagram-post-textarea.html">

<dom-module id="instagram-post">
  <template>
    <style>
    :host {
      display: block;
    }
    :host([hidden]) {
      display: none;
    }
    .instagram-footer {
      vertical-align: middle;
      -webkit-box-align:center;
      -webkit-align-items:center;
      -ms-flex-align:center;
      align-items:center;
      border-top:1px solid #eee;
      -webkit-box-orient:horizontal;
      -webkit-box-direction:normal;
      -webkit-flex-direction:row;
      -ms-flex-direction:row;
      flex-direction:row;
      height:24px;
      padding:10px
    }
    .instagram-glyph {
      display: inline-block;
      float: right;
      -webkit-box-align:center;
      -webkit-align-items:center;
      -ms-flex-align:center;
      align-items:center;
      vertical-align: middle;
      height: 24px;
      width: 26px;
      overflow: hidden;
      background-position: -24px 0px;
      background-image: url(f8cfa266e12d.png);
      background-size: 74px 49px;
    }
    .instagram-logo {
      background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC);
      display:block;
      height:44px;
      margin:0 auto -44px;
      position:relative;
      top:-22px;
      width:44px;
    }
    .instagram-playbutton {
      display: block;
      height: 135px;
      left: 50%;
      margin-left: -67px;
      margin-top: -67px;
      top: 50%;
      width: 135px;
      position: absolute;
      background-image: url(06390c4e5e96.png);
      background-size: 152px 135px;
      background-position: 0 0;
      transition-property: opacity;
      transition-duration: 0.3s;
      transition-timing-function: ease-out;
      transition-delay: .1s;
      opacity: var(--playbutton-opacity);
    }
    .instagram-post {
      background:#FFF;
      border:0;
      border-radius:3px;
      box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15);
      margin: 1px;
      max-width:658px;
      padding:0;
      width:99.375%;
      width:-webkit-calc(100% - 2px);
      width:calc(100% - 2px);
    }
    .instagram-temp {
      background:#F8F8F8;
      line-height:0;
      padding:62.5% 0;
      text-align:center;
      width:100%;
    }

    .instagram-time {
      display: inline-block;
      font-size:12px;
      text-decoration: none;
      line-height:17px;
    }
    .instagram-video {
      width: 100%;
      height: 100%;
      position: relative;
    }
    </style>

    <blockquote class="instagram-post">
      <instagram-post-header authorid="[[_authorId]]" authorurl="[[_authorUrl]]" avatar="[[_avatar]]" verified="[[_instaObject.verified]]">
      </instagram-post-header>
      <template is="dom-if" if="[[_loaded]]">
        <template is="dom-if" if="{{!_isVideo(_graphType)}}">
          <instagram-post-image image=[[_instaObject.imgSrc]]>
          </instagram-post-image>
        </template>
        <template is="dom-if" if="{{_isVideo(_graphType)}}">
          <instagram-post-video poster=[[_instaObject.imgSrc]] video=[[_instaObject.videoSrc]]>
          </instagram-video>
        </template>
      </template>
      <div class="instagram-temp" hidden$=[[_loaded]]>
        <div class="instagram-logo"></div>
      </div>
      <template is="dom-if" if="[[_loaded]]">
        <instagram-post-textarea author=[[_authorId]] authorurl=[[_authorUrl]] comments=[[_instaObject.comments]] instagramurl=[[_instagramUrl]] text=[[_instaObject.instagramText]] likes=[[_instaObject.likes]]>
        </instagram-post-textarea>
      </template>
      <div class="instagram-footer">
        <a class="instagram-time gray" href="#">[[_humanDate]]</a>
        <span class="instagram-glyph"></span>
      </div>
    </blockquote>
  </template>

  <script>
  /**
  * `instagram-post`
  * Display an Instagram post in your Polymer website
  *
  * @customElement
  * @polymer
  * @demo demo/index.html
  */
  class InstagramPost extends Polymer.Element {
    static get is() { return 'instagram-post'; }
    static get properties() {
      return {
        /**
        * postid: ID of Instagram post
        * @type {String}
        */
        postid: {
          type: String
        },
        /**
        * _authorId: Author ID of the Instagram post
        * @type {String}
        */
        _authorId: {
          type: String
        },
        /**
        * _authorUrl: Computed URL leading to author's Instagram page
        * @type {String}
        */
        _authorUrl: {
          type: String,
          computed: '_computeAuthorUrl(authorId)'
        },
        /**
        * _avatar: Author's avatar image
        * @type {String}
        */
        _avatar: {
          type: String
        },
        /**
        * _graphType: Either GraphImage or GraphVideo from Instragram's POST data
        * @type {String}
        */
        _graphType: {
          type: String
        },
        /**
        * _humanDate: Computed Human readable date
        * @type {String}
        */
        _humanDate: {
          type: String,
          computed: '_computeHumanDate(_instaObject.timestamp)'
        },
        /**
        * _loaded: Set true when received POST data from Instagram
        * @type {String}
        */
        _loaded: {
          type: String,
          computed: '_computeHumanDate(_instaObject.timestamp)'
        },
        /**
        * _instaObject: Container for post details
        * @type {Object}
        */
        _instaObject: {
          type: Object,
          value: {}
        },
        /**
        * _instagramUrl: Computed URL of instagram post
        * @type {String}
        */
        _instagramUrl: {
          type: String,
          computed: '_buildUrl(postid)',
          observer: '_getInstagramAPI'
        },
        /**
        * _playing: Flag for wether video is playing
        * @type {Boolean}
        */
        _playing: {
          type: Boolean,
          value: false
        }
      };
    }

    _buildUrl(postid) {
      if (!postid)
      return;
      return 'https://www.instagram.com/p/' + postid;
    }

    _computeAuthorUrl(authorId) {
      if (!authorId)
      return;
      return 'https://www.instagram.com/' + authorId;
    }

    _computeHumanDate(timestamp) {
      if (!timestamp)
      return;
      let postDate = new Date(timestamp*1000);
      let elapsedTime = new Date() - postDate
      if ( elapsedTime < 84400000*7) {
        return Math.round(elapsedTime/84400000) + " days ago"
      } else {
        var options = { year: 'numeric', month: 'long', day: 'numeric' };
        return postDate.toLocaleDateString("en-US",options)
      }
    }
    _isVideo(graphType) {
      if (!graphType)
        return;
      if (graphType == 'GraphVideo')
        return true;
      else
        return false;
    }

    _getInstagramAPI(instagramUrl) {
      var xhr = new XMLHttpRequest();
      xhr.addEventListener("load", (e) => {
        if (e.target.status == 200) {
          let responseObj = JSON.parse(e.target.response);
          let graphql = responseObj.graphql.shortcode_media;
          this.set('_instaObject.imgSrc', graphql.display_url);
          this.set('_instaObject.videoSrc', graphql.video_url);
          this.set('_instaObject.instagramText', graphql.edge_media_to_caption.edges[0].node.text);
          this.set('_graphType', graphql.__typename);
          this.set('_authorId', graphql.owner.username);
          this.set('_avatar', graphql.owner.profile_pic_url);
          this.set('_instaObject.timestamp', graphql.taken_at_timestamp);
          this.set('_instaObject.likes', graphql.edge_media_preview_like.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
          this.set('_instaObject.comments', graphql.edge_media_to_comment.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
          this.set('_instaObject.verified', graphql.owner.is_verified);
          this.set('._loaded', true);
        }
      });
      xhr.open("GET", this._instagramUrl + "/?__a=1");
      xhr.send();
    }

    connectedCallback() {
      super.connectedCallback();
    }
  }

  window.customElements.define(InstagramPost.is, InstagramPost);
</script>
</dom-module>
