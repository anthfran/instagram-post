<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="./instagram-image.html">
<link rel="import" href="./instagram-video.html">

<dom-module id="instagram-post">
  <template>
    <style>
    :host {
      display: block;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }
    :host([hidden]) {
      display: none;
    }
    blockquote {
      background:#FFF;
      border:0;
      border-radius:3px;
      box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15);
      margin: 1px;
      max-width:658px;
      padding:0;
      width:99.375%;
      width:-webkit-calc(100% - 2px);
      width:calc(100% - 2px);
    }
    .black {
      color: #000;
    }
    .bolded {
      font-weight: 600;
    }
    .gray {
      color: #999;
    }
    .author {
      color:#262626;
      font-family:Arial,sans-serif;
      font-size:14px;
      font-weight: 600;
      font-style:normal;
      line-height:17px;
    }
    .avatar {
      height: 30px;
      width: 30px;
    }
    .avatar img{
      border-radius: 50%;
      height: 30px;
      width: 30px;
    }
    .footer {
      vertical-align: middle;
      -webkit-box-align:center;
      -webkit-align-items:center;
      -ms-flex-align:center;
      align-items:center;
      border-top:1px solid #eee;
      -webkit-box-orient:horizontal;
      -webkit-box-direction:normal;
      -webkit-flex-direction:row;
      -ms-flex-direction:row;
      flex-direction:row;
      height:24px;
      padding:10px
    }
    .glyph {
      display: inline-block;
      float: right;
      -webkit-box-align:center;
      -webkit-align-items:center;
      -ms-flex-align:center;
      align-items:center;
      vertical-align: middle;
      height: 24px;
      width: 26px;
      overflow: hidden;
      background-position: -24px 0px;
      background-image: url(f8cfa266e12d.png);
      background-size: 74px 49px;
    }
    .header {
      -webkit-box-align: center;
      -webkit-align-items: center;
      -ms-flex-align: center;
      align-items: center;
      display: -webkit-box;
      display: -webkit-flex;
      display: ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -webkit-flex-direction: row;
      -ms-flex-direction: row;
      flex-direction: row;
      height: 34px;
      padding: 10px;
    }
    .logo {
      background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC);
      display:block;
      height:44px;
      margin:0 auto -44px;
      position:relative;
      top:-22px;
      width:44px;
    }
    .temp {
      background:#F8F8F8;
      line-height:0;
      padding:50% 0;
      text-align:center;
      width:100%;
    }
    .text {
      font-size:14px;
      font-style:normal;
      font-weight:normal;
      line-height:17px;
      text-decoration:none;
      word-wrap:break-word;
    }
    .textbox {
      margin:8px 0;
      padding:0 10px;
    }
    .time {
      display: inline-block;
      font-size:12px;
      text-decoration: none;
      line-height:17px;
      color: #999;
    }
    .username {
      -webkit-box-align: center;
      -webkit-align-items: center;
      -ms-flex-align: center;
      align-items: center;
      display: -webkit-box;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -webkit-flex-direction: row;
      -ms-flex-direction: row;
      flex-direction: row;
      font-weight: 600;
      color: #262626;
      text-decoration: none;
      padding: 0 10px;
    }
    .verified {
      height: 12px;
      width: 12px;
      overflow: hidden;
      background-position: -50px -25px;
      background-image: url(f8cfa266e12d.png);
      background-size: 74px 49px;
    }
    </style>

    <blockquote class="instagram-container">
      <div class="header">
        <a class="avatar" href$=[[_authorUrl]] target="_blank">
          <img id="instagramAvatar" alt$=[[_authorId]]>
        </a>
        <a class="username" href$=[[_authorUrl]] target="_blank">
          <span>[[_authorId]]</span>
        </a>
        <template is="dom-if" if="[[_verified]]">
          <span class="verified">
        </template>
        </span>
      </div>
      <template id="templateImage" is="dom-if" if="{{!_isVideo(_instaObject.graphType)}}">
        <a href$=[[_instagramUrl]] hidden$="[[!_loaded]]">
          <instagram-image id="elementImage" imageurls="[[_instaObject.imgSrc]]">
          </instagram-image>
        </a>
      </template>
      <template id="templateVideo" is="dom-if" if="{{_isVideo(_instaObject.graphType)}}">
        <instagram-video poster=[[_instaObject.imgSrc]] video=[[_instaObject.videoSrc]]>
        </instagram-video>
      </template>
      <div class="temp" hidden$=[[_loaded]]>
        <div class="logo"></div>
      </div>
      <div hidden$="[[!_loaded]]">
        <p class="textbox">
          <a class="text bolded black" href$=[[_instagramUrl]] target="_blank">[[_instaObject.likes]] likes</a>
        </p>
        <p class="textbox">
          <a href$=[[_authorUrl]] class="author" target="_blank">[[_authorId]]</a> <a class="text black" href$=[[_instagramUrl]] target="_blank">[[_instaObject.instagramText]]</a>
        </p>
        <p class="textbox">
          <a class="text gray" href$=[[_instagramUrl]] target="_blank">view all [[_instaObject.comments]] comments</a>
        </p>
      </div>
      <div class="footer">
        <a class="time gray" href="#">[[_humanDate]]</a>
        <span class="glyph"></span>
      </div>
    </blockquote>
  </template>

  <script>
  /**
  * `instagram-post`
  * Display an Instagram post in your Polymer website
  *
  * @customElement
  * @polymer
  * @demo demo/index.html
  */
  class InstagramPost extends Polymer.Element {
    static get is() { return 'instagram-post'; }
    static get properties() {
      return {
        /**
        * postid: ID of Instagram post
        */
        postid: {
          type: String,
          observer: '_fetchPost'
        },
        /**
        * _authorId: Author ID of the Instagram post
        */
        _authorId: {
          type: String
        },
        /**
        * _authorUrl: Computed URL leading to author's Instagram page
        */
        _authorUrl: {
          type: String,
          computed: '_computeAuthorUrl(_authorId)'
        },
        /**
        * _humanDate: Computed Human readable date
        */
        _humanDate: {
          type: String,
          computed: '_computeHumanDate(_instaObject.timestamp)'
        },
        /**
        * _loaded: Set true when received POST data from Instagram
        */
        _loaded: {
          type: Boolean,
          value: false
        },
        /**
        * _instaObject: Container for post details
        */
        _instaObject: {
          type: Object,
          value: {}
        },
        /**
        * _instagramUrl: Computed URL of instagram post
        */
        _instagramUrl: {
          type: String,
          computed: '_computeUrl(postid)'
        },
        /**
        * _verified: Wether user is a verified user and enables the checkmark to be displayed
        */
        _verified: {
          type: Boolean,
          value: false
        }
      };
    }
    _fetchPost(postId){
      let fetchUrl = "https://www.instagram.com/p/".concat(postId).concat("?__a=1");
      const options = { method: 'GET', mode: 'cors', headers: { Accept: 'application/json' }};
      fetch(fetchUrl, options)
      .then((response) => {
        if (response.status >= 200 && response.status <= 300) return Promise.resolve(response);
        else return Promise.reject(response);
      })
      .then((body) => {
        return body.json();
      })
      .then((json) => {
        let graphql = json.graphql.shortcode_media;
        this.$.instagramAvatar.src = graphql.owner.profile_pic_url;
        if (!graphql.edge_sidecar_to_children) {
          this.set('_instaObject.imgSrc', [graphql.display_url]);
        } else {
          let edges = graphql.edge_sidecar_to_children.edges;
          let images = [];
          for (let i = 0; i < edges.length; i++) {
            images.push(edges[i].node.display_url);
          }
          this.set('_instaObject.imgSrc', images);
        }
        this.set('_authorId', graphql.owner.username);
        this.set('_instaObject.videoSrc', graphql.video_url);
        this.set('_instaObject.instagramText', graphql.edge_media_to_caption.edges[0].node.text);
        this.set('_instaObject.graphType', graphql.__typename);
        this.set('_instaObject.timestamp', graphql.taken_at_timestamp);
        this.set('_instaObject.likes', graphql.edge_media_preview_like.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
        this.set('_instaObject.comments', graphql.edge_media_to_comment.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
        this.set('_verified', graphql.owner.is_verified);
        this.set('_loaded', true);
        this.dispatchEvent(new CustomEvent('test-event', {detail: "ready"}));
      })
      .catch((error) => {
        console.log("Fetch error", error);
      });
    }
    /**
     * Builds a URL for links to post author's Instagram page
     *
     * @param {String} authorId of the post
     * @return {String} URL of post author's page
     */
    _computeAuthorUrl(authorId) {
      if (!authorId) return;
      return 'https://www.instagram.com/' + authorId;
    }
    /**
     * For time elapsed of less than 10 days, returns a "X days ago" String
     * Else, returns the date in the format "Month DD, YYYY"
     *
     * @param {number} timestamp of the post
     * @return {String} Human readable date
     */
    _computeHumanDate(timestamp) {
      if (!timestamp) return;
      let postDate = new Date(timestamp*1000);
      let elapsedTime = new Date() - postDate
      if ( elapsedTime < 84400000*7) {
        return Math.round(elapsedTime/84400000) + " days ago"
      } else {
        var options = { year: 'numeric', month: 'long', day: 'numeric' };
        return postDate.toLocaleDateString("en-US",options)
      }
    }
    /**
     * Computes a URL required for the REST call to Instagram
     *
     * @param {String} postid of the
     * @return {String} URL of the post
     */
    _computeUrl(postid) {
      if (!postid) return;
      return 'https://www.instagram.com/p/' + postid;
    }
    /**
     * Instagram provides either "GraphVideo" or "GraphImage"
     * This will convert to boolean, required by dom-if's on the page
     *
     * @param {String} graphType of the post
     * @return {Boolean} True if Video, False if Image
     */
    _isVideo(graphType) {
      if (!graphType) return;
      if (graphType == 'GraphVideo')
        return true;
      else
        return false;
    }

    connectedCallback() {
      super.connectedCallback();
    }
  }

  window.customElements.define(InstagramPost.is, InstagramPost);
</script>
</dom-module>
